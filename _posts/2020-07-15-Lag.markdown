---
layout: post
title:  "Link Aggregation - Ethernet Bonding"
date:   2020-07-15 13:03:36 +0530
categories: L2 Linux Disponibilidade Redes Bonding
---

---
 Neste post tentarei explicar como funciona o Link Aggregation, que é bastante comum em Uplinks entre switches e routers mas que também pode ser aplicado em hosts, em nosso caso aplicaremos em um servidor GNU/Linux Debian Buster. 

---


**Como funciona o Link Aggregation?**

O Link Aggregation está descrito na norma IEEE 802.3ad, e possibilita vincular dois um mais links ethernet através de um único link virtual. 

Esta funcionalidade nos permite prover alta disponibilidade para rescursos importantes em uma rede, neste exemplo será usado um servidor Linux com duas interfaces Ethernet e um módulo que está no kernel chamado `bonding`. 

![lag](https://raw.githubusercontent.com/keilon-araujo/teste/master/lag.png)

O módulo bonding tem 7 modos de operação e cada oferece recursos diferentes. Neste cenário vamos usar `Mode=0 (balance round-robin)` o qual provê tolerancia à falhas dos links e também faz o balanceamento de cargas. Outros parametros também podem ser utilizados, como o `miimom` que define o tempo de espera para monitoramento da interface bounding, `downdelay` que define o tempo de espera para desabilitar uma interface escrava em caso de falha e deve ser usada em conjunto com miimom e também o parametro `updelay` o qual define o tempo de espera para ativar uma interface escrava após detecção de normalização do link principal.


Para configuração vamos utilizar duas interfaces físicas sendo elas enp1s0 e enp7s0 como escravas e criaremos uma interface virtual `bond0` no modo `active-backup`:
~~~
miimom=100    -> o link será monitorado a cada 100 milisegundos
downdelay=200 -> a interface ativada só será desabilitada em caso de falha após 200 milisegundos
updelay=220   -> tempo que o link principal irá retomar após falha
~~~

O Debian Buster temos que instalar o `ifenslave` que irá ativar/desativar as interfaces, como usuário root vamos às configurações:

~~~shell
root@server~# apt install ifenslave
~~~

Em seguida ativamos o módulo bonding no Kernel:

~~~shell
root@server~# modprobe bonding
~~~

Verificando se o módulo foi ativado:

~~~shell
root@server~# lsmod | grep bonding
bonding               180224  0
~~~

O próximo passo é configurar as interfaces, aqui será criado o link virtual `bond0` e as interfaces que farão parte do Link Aggregation serão declaradas dentro desta. No Debian Buster todas interfaces são configuradas em um único arquivo que fica em `/etc/network/interfaces`.

~~~shell
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
#allow-hotplug enp1s0
#iface enp1s0 inet dhcp
#

# Interface bonding
# Static IP address
auto bond0
iface bond0 inet static
        bond-slaves enp1s0 enp7s0
        bond-mode  balance-rr
        bond-miimon 100
	bond-updelay 220
	bond-downdelay 220
        bond-primary enp1s0 enp7s0

        address 192.168.122.188
        netmask 255.255.255.0
        network 192.168.122.0
        broadcast 192.168.122.255
        gateway 192.168.122.1

~~~
